<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Robot Interaction Panel</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Orbitron', sans-serif;
}

body {
    height: 100vh;
    background: radial-gradient(circle at top, #0f2027, #000);
    display: flex;
    justify-content: center;
    align-items: center;
    color: #00ffe1;
}

.panel {
    width: 92%;
    max-width: 1000px;
    padding: 35px;
    background: rgba(0,0,0,0.8);
    border-radius: 25px;
    box-shadow: 0 0 40px #00ffe1;
    text-align: center;
}

h1 {
    margin-bottom: 25px;
    letter-spacing: 3px;
}

.icons {
    display: flex;
    justify-content: center;
    gap: 35px;
    flex-wrap: wrap;
}

.icon {
    width: 160px;
    height: 160px;
    background: linear-gradient(145deg, #00ffe1, #007777);
    border-radius: 30px;
    font-size: 3.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 0 25px #00ffe1;
    transition: transform 0.25s, box-shadow 0.25s;
}

.icon:hover {
    transform: scale(1.15);
    box-shadow: 0 0 45px #00ffe1;
}

.label {
    margin-top: 10px;
    font-size: 0.9rem;
    letter-spacing: 1px;
}

video {
    width: 100%;
    margin-top: 25px;
    border-radius: 18px;
    border: 2px solid #00ffe1;
    display: none;
    box-shadow: 0 0 25px #00ffe1;
}

input {
    margin-top: 20px;
    width: 80%;
    padding: 12px;
    border-radius: 10px;
    border: none;
    outline: none;
    font-family: 'Orbitron', sans-serif;
}
</style>
</head>

<body>

<div class="panel">
    <h1>CAS-E INTERACTION PANEL</h1>

    <div class="icons">
        <div>
            <div class="icon" onclick="toggleCamera()">ðŸ“·</div>
            <div class="label">CAMERA</div>
        </div>

        <div>
            <div class="icon" onclick="toggleMic()">ðŸŽ¤</div>
            <div class="label">MIC</div>
        </div>

        <div>
            <div class="icon" onclick="speak()">ðŸ”Š</div>
            <div class="label">SPEAKER</div>
        </div>
    </div>

    <div style="margin-top:18px; display:flex; gap:8px; justify-content:center; align-items:center;">
        <select id="videoSource" style="padding:8px; border-radius:8px; display:none;"></select>
        <button class="icon" id="cameraBtn" onclick="toggleCamera()" style="width:auto;height:48px;font-size:1.4rem;padding:0 14px;">Toggle Camera</button>
        <button class="icon" id="refreshDevices" onclick="updateDeviceList()" style="width:auto;height:48px;font-size:1.1rem;padding:0 12px;">Refresh Devices</button>
    </div>

    <video id="video" autoplay playsinline muted style="display:none"></video>

    <div id="msg" style="margin-top:12px;color:#ffd; font-size:0.9rem;">Tip: If camera doesn't appear, serve this page over HTTP(S) (see below).</div>

    <input id="ttsText" type="text" placeholder="Type what the robot should say...">
</div>

<script>
let camStream = null;
let micStream = null;
let audioElem = null;

// helper getters
const msgEl = () => document.getElementById('msg');
const videoSelect = () => document.getElementById('videoSource');
const videoEl = () => document.getElementById('video');

// CAMERA
async function toggleCamera() {
    const video = videoEl();

    if (camStream) {
        camStream.getTracks().forEach(t => t.stop());
        camStream = null;
        video.style.display = 'none';
        msgEl().textContent = 'Camera stopped.';
        return;
    }

    // Check secure context (getUserMedia requires HTTPS or localhost)
    if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
        msgEl().innerHTML = 'Camera requires a secure context (HTTPS) or running on <strong>localhost</strong>. Run a local server (see instructions below).';
        return;
    }

    // Build constraints with optional selected device and conservative resolution for Raspberry Pi
    let deviceId = videoSelect().value || undefined;
    const constraints = {
        video: {
            width: { ideal: 640 },
            height: { ideal: 480 },
            deviceId: deviceId ? { exact: deviceId } : undefined,
            facingMode: 'environment'
        },
        audio: false
    };

    try {
        camStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = camStream;
        video.muted = true; // help autoplay policies
        video.playsInline = true;
        await video.play();
        video.style.display = 'block';
        msgEl().textContent = 'Camera active.';
        await updateDeviceList();
    } catch (err) {
        console.error('getUserMedia error', err);
        if (err.name === 'NotAllowedError' || err.name === 'SecurityError') {
            msgEl().textContent = 'Permission denied for camera. Check browser permissions.';
        } else if (err.name === 'NotFoundError' || err.name === 'OverconstrainedError') {
            msgEl().textContent = 'No camera found or requested constraints not supported. Try Refresh Devices.';
        } else {
            msgEl().textContent = 'Camera error: ' + err.message;
        }
    }
}

// MIC â†’ SPEAKER LOOPBACK
async function toggleMic() {
    if (micStream) {
        micStream.getTracks().forEach(t => t.stop());
        micStream = null;
        if (audioElem) audioElem.pause();
        return;
    }

    try {
        micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioElem = new Audio();
        audioElem.srcObject = micStream;
        audioElem.play();
    } catch (err) {
        console.error('Microphone error', err);
        msgEl().textContent = 'Microphone error: ' + (err.message || err.name);
    }
}

// TEXT TO SPEECH
let femaleVoice = null;

// Load voices (IMPORTANT)
function loadVoices() {
    const voices = speechSynthesis.getVoices();

    femaleVoice = voices.find(v =>
        v.name.toLowerCase().includes('zira') ||
        v.name.toLowerCase().includes('aria') ||
        v.name.toLowerCase().includes('female') ||
        v.name.toLowerCase().includes('woman')
    );

    if (!femaleVoice) {
        femaleVoice = voices.find(v => v.lang && v.lang.startsWith('en'));
    }

    console.log('Selected voice:', femaleVoice?.name);
}

speechSynthesis.onvoiceschanged = loadVoices;

// SPEAK FUNCTION
function speak() {
    const text =
        document.getElementById('ttsText').value ||
        'Hello, I am casey';

    const utterance = new SpeechSynthesisUtterance(text);

    if (femaleVoice) {
        utterance.voice = femaleVoice;
    }

    utterance.pitch = 1.3;
    utterance.rate = 0.95;
    utterance.volume = 1;

    speechSynthesis.speak(utterance);
}

// Update device list (shows available video input devices)
async function updateDeviceList() {
    const select = videoSelect();
    select.style.display = 'none';
    try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === 'videoinput');
        select.innerHTML = '';
        if (videoDevices.length === 0) {
            msgEl().textContent = 'No video devices found.';
            return;
        }
        videoDevices.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.deviceId;
            opt.text = d.label || ('Camera ' + (select.length + 1));
            select.appendChild(opt);
        });
        select.style.display = 'inline-block';
        msgEl().textContent = '';
    } catch (e) {
        console.error('enumerateDevices failed', e);
        msgEl().textContent = 'Unable to enumerate devices. Grant camera permission or try Refresh.';
    }
}

// On load: try to populate devices if possible
if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
    updateDeviceList().catch(e => console.warn(e));
} else {
    msgEl().textContent = 'Browser does not support media device enumeration.';
}
</script>


</body>
</html>
